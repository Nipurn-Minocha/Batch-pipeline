# Containerized batch pipeline using DockerHub,Pachyderm, Google Cloud Storage,Postgres Cloud Database
## About this Repository
This repository contains the pipeline specifications and code for making batch pipelines for the 
larger [Hugging  Face Transformers](https://huggingface.co/models) based Question Answer model.  
## Purpose
This repository contains two pipelines. 
### Pipeline 1 : Pulls the data uploaded by a user in a google cloud storage in the form of CSVs . 
There CSVs contain a list of questions and contexts . It then processes the questions asked to fetch ansers using a defualt BERT model for question answering .
Answers fetched are then written to an output directory.
### Pipeline 2: Pushes the answers created by first pipeline to a PostGres database on google cloud. 
The goal of these batch pipelines is to act as data pipelines between the CLoud storage and the 
Cloud SQL database, where the answers generated by the pipeline is stored.
The pipelines automates the data storage process by acting as a non-real time data updation
link between the model and the database. 
Below is a high-level diagram to show how the pipelines fit in the overall framework:</br>

Below is a high-level diagram to show how the pipelines fit in the overall framework:</br>

 

<img width="889" alt="3" src="https://user-images.githubusercontent.com/84465734/121768365-e02cd980-cb2b-11eb-9a6e-7776ff856d55.PNG">




## Deploying these pipelines
### Prerequisites 
- Must have a valid account on dockerhub - 
- Must have a google cloud storage already set up 
- Must have access to pachyderm - https://hub.pachyderm.com/landing

 

### Below are the steps to deploy your pipelines via Pachyderm:
Once the above pre-requisites are confirmed ,checkout this repository and proceed as below:
###  Build and deploy the docker images to DockerHub
- Add secret DOCKERHUB_USERNAME = <Your dockerhub username> in github secrets
- Add secret DOCKERHUB_TOKEN = <Your dockerhub access> in github secrets 
- Change your <your-dockerhub-username>/<docker-imaeg-name> in  .github/workflows/main.yml
        - - name: Build and push
      run: |-
        cd pachyderm_01 && docker build -t <your-dockerhub-username>/<docker-imaeg-name>:${{  github.sha }} .
        docker push <your-dockerhub-username>/<docker-imaeg-name>:${{  github.sha }} && cd ../
        cd pachyderm_02 && docker build -t <your-dockerhub-username>/<docker-imaeg-name>:${{  github.sha }} .
        docker push <your-dockerhub-username>/<docker-imaeg-name>:${{  github.sha }}
### TODO : provide a ref link on how to fetch dockerhub access token and adding to secrets
###  Create pachyderm workspace
####  Sign-in to Pachyderm
#### https://hub.pachyderm.com/landing
####  Create a new workspace as shown below
   <img width="309" alt="1" src="https://user-images.githubusercontent.com/84465734/121768778-fb98e400-cb2d-11eb-91c4-46e1946636f2.PNG">
 Refer : https://docs.pachyderm.com/latest/hub/hub_getting_started/
####  Login to Pachyderm Cluster 
## TODO 
####  Install pachctl on your machine
The "pachctl" or pach control is a command line tool that you can use to interact with a Pachyderm cluster in your terminal. For a Debian based Linux 64-bit or Windows 10    or later running on WSL run the following code:
   ```
   curl -o /tmp/pachctl.deb -L https://github.com/pachyderm/pachyderm/releases/download/v1.13.2/pachctl_1.13.2_amd64.deb && sudo dpkg -i /tmp/pachctl.deb
   ```
For macOS use the below command:
   ```
   brew tap pachyderm/tap && brew install pachyderm/tap/pachctl@1.13
   ```
For all other Linux systems use below command:
   ```
   curl -o /tmp/pachctl.tar.gz -L https://github.com/pachyderm/pachyderm/releases/download/v1.13.2/pachctl_1.13.2_linux_amd64.tar.gz && tar -xvf /tmp/pachctl.tar.gz -C /tmp && sudo cp /tmp/pachctl_1.13.2_linux_amd64/pachctl /usr/local/bin
   ```
Refer : https://docs.pachyderm.com/latest/getting_started/local_installation/#install-pachctl
####  Connect to your Pachyderm workspace
Click "Connect" on your Pachyderm workspace and follow the below listed steps to connect to your workspace via the machine:
   
   <img width="306" alt="2" src="https://user-images.githubusercontent.com/84465734/121769024-50892a00-cb2f-11eb-8546-97b039618abb.PNG">
    
####  Verify the installation
   ```
    pachctl version
   ```

####  Copy below files to your local system (where pachtcl is installed)
  - create_secret.sh
  - create_secret_db.sh
  - secret_template.json
  - secret_template_db.jso
  - credentials.json <your service account for google cloud storage>
  - server-ca.pem <your server certificate for Postgres database>
  - client-cert.pem <your client certificate for Postgres database>
  - client-key.pem <your client key for Postgres database>
Export the required environment variables to your OS environment .
For Example : If you are using LINUX , you can you below commands:
```
export GOOGLE_APPLICATION_CREDENTIALS=<YOUR-CLOUD-SERVICE_ACCOUNT_KEY>
export PG_HOST=<POSTGRES-DATABASE-HOST>
export PG_PASSWORD=<POSTGRES-DATABASE-PASSWOD>
export PG_DBNAME=<POSTGRES-DATABASE-DBNAME>
export PG_USER=<POSTGRES-DATABASE-USER>
export PG_SSLROOTCERT=<POSTGRES-DATABASE-HOST>
export PG_SSLCLIENT_CERT=<POSTGRES-DATABASE-HOST>
export PG_SSL_CLIENT_KEY=<POSTGRES-DATABASE-HOST>
```









### About Pachyderm
Pachyderm  gives teams the ability to control access to production pipelines, data, and configuration. Administrators can silo data, prevent unintended modifications to production pipelines, and support multiple data scientists or even multiple data science groups
Pachyderm is built with the intention of performing data parallelism. By defining glob patterns in our pipeline, we can specify how Pachyderm should split the data so that the code can execute as parallel jobs without having to modify the underlying implementation.
Pachyderm is built on top of Kubernetes


Architecture

![image](https://user-images.githubusercontent.com/54888893/121793711-f2f8ea00-cbcf-11eb-902f-fc7a41c735de.png)

The project builds a docker image used by the 2 pipelines every time the code is committed and pushed to the repo. 
To get started, you need to login or signup to hub.pachyderm.com

![image](https://user-images.githubusercontent.com/54888893/121793873-52a3c500-cbd1-11eb-8571-0f01db7c542a.png)

•	Creating a workspace
Click the Create a 4-hr Workspace button and fill out the form.
•	Install pachtctl
pachctl is a command-line tool that you can use to interact with a Pachyderm cluster in your terminal.
In google cloud shell, 
```
curl -o /tmp/pachctl.deb -L https://github.com/pachyderm/pachyderm/releases/download/v1.13.2/pachctl_1.13.2_amd64.deb && sudo dpkg -i /tmp/pachctl.deb

```

After the workspace creation, open terminal window and install pachtctl using 
```
Install pachctl
```
•	Configure the Context and log in to the hub 
To configure a Pachyderm context and log in to your workspace , click the Connect link on your workspace name in the Hub UI and follow the steps. 

Run the following in the terminal
```
echo '{"pachd_address": "grpcs://hub-c0-4we50w0c91.clusters.pachyderm.io:31400", "source": 2}' | pachctl config set context "Assignment4" --overwrite && pachctl config set active-context "Assignment4"
```
Login with:

```
pachctl auth login --one-time-password
```
When prompted enter 
```
otp/396fcbf4a3894ea48cf155b24dc4b3c7
```

Verify that you have set the correct context
```
pachctl config get active-context
```
The system will return the name of the workspace
```
Assignment4
```
•	Build Docker and push the Docker
Log in to Docker hub and create a public repository.
To build and push your Docker, use the following comman with your username/Reponame
Eg:
```
docker build -t nminocha/pipeline-1 .
docker login
docker push nminocha/pipeline-1 
```

•	Create a pipeline 
Create a new pipeline from a pipeline specification. Pachyderm's pipeline specifications can be written in JSON or YAML. 
```
-b, --build             If true, build and push local docker images into the docker registry.
  -f, --file string       The JSON file containing the pipeline, it can be a url or local file. - reads from stdin. (default "-")
  -h, --help              help for pipeline
  -p, --push-images       If true, push local docker images into the docker registry.
  -r, --registry string   The registry to push images to. (default "index.docker.io")
  -u, --username string   The username to push images as.
  ```
The specs.JSON file includes the specification for our project. 
```
pachctl create-pipeline -f spec.json
                   ```
```
pachctl list pipeline
                   

![image](https://user-images.githubusercontent.com/54888893/121793896-9c8cab00-cbd1-11eb-893d-6f828907a1e2.png)




pachctl list job
                   
![image](https://user-images.githubusercontent.com/54888893/121794050-2721da00-cbd3-11eb-958c-e9773fca993f.png)


On Pachyderm dashboard, we can see it as follows after 1st pipeline creation:

![image](https://user-images.githubusercontent.com/54888893/121794063-3ef95e00-cbd3-11eb-8d8a-c6e3627d1e49.png)

Similar procedure to be followed for 2nd pipeline where you will be able to see output from first pipeline going as input to second
